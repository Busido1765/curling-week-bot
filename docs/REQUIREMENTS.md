# REQUIREMENTS.md  
Telegram-бот проекта «Неделя кёрлинга»

## 1. Общая цель проекта

Telegram-бот используется как обязательный этап подтверждения регистрации
на мероприятие «Неделя кёрлинга», а также как основной канал коммуникации
с участниками проекта.

Бот решает следующие задачи:
- подтверждает регистрацию пользователя после регистрации на сайте;
- проверяет обязательную подписку на Telegram-канал Федерации кёрлинга России;
- рассылает новости и анонсы участникам проекта;
- предоставляет справочную информацию (локации, расписание, FAQ, контакты).

---

## 2. Роли и доступы

### 2.1 Роли

В системе существуют следующие логические роли:

- **Admin**
  - определяется по списку `ADMIN_IDS` (Telegram ID), заданному вручную в конфигурации;
  - имеет доступ к админским функциям (создание постов, обновление страниц).

- **User**
  - любой пользователь, написавший боту.

- **Participant**
  - пользователь, пришедший в бота по токену с сайта;
  - прошедший проверку подписки на обязательный канал;
  - получающий рассылки проекта.

> Роли не взаимоисключающие: администратор может быть участником проекта.

---

## 3. Модель регистрации пользователя

### 3.1 Статусы регистрации

Каждый пользователь имеет один из следующих статусов:

- `NONE`  
  Пользователь не проходил регистрацию на сайте (нет валидного токена).

- `TOKEN_VERIFIED`  
  Пользователь пришёл в бота по валидному токену с сайта.

- `SUBSCRIPTION_VERIFIED`  
  Пользователь подтвердил подписку на обязательный Telegram-канал.

- `CONFIRMED`  
  Регистрация полностью подтверждена (токен + подписка).

### 3.2 Токен регистрации

- Пользователь приходит в бот по ссылке вида `/start <token>`.
- Токен:
  - подписанный (JWT / HMAC);
  - имеет срок жизни (TTL), рекомендуемое значение — **7 дней**;
  - валидируется ботом по секрету.
- Для MVP допускается использование заглушки (`StubTokenVerifier`).

Если токен:
- отсутствует;
- невалиден;
- просрочен;

→ пользователь считается `NONE` и получает сообщение с предложением пройти регистрацию на сайте заново.

---

## 4. Обязательная подписка на канал Федерации

### 4.1 Требование

Для участия в проекте пользователь **обязан быть подписан** на Telegram-канал
Федерации кёрлинга России.

Без подписки:
- регистрация не считается подтверждённой;
- пользователь не получает рассылки проекта.

### 4.2 Проверка подписки

- Бот предоставляет кнопку **«Проверить подписку»**.
- При нажатии бот проверяет статус пользователя через Telegram API (`getChatMember`).
- Частота проверок ограничивается (не чаще одного раза в ~3 секунды на пользователя).
- Бот должен быть администратором проверяемого канала.

---

## 5. Аудитории

Бот различает следующие группы пользователей:

- `started_users` — все пользователи, которые когда-либо писали боту;
- `confirmed_users` — пользователи со статусом `CONFIRMED`;
- `admins` — пользователи, входящие в `ADMIN_IDS`.

**Все рассылки проекта отправляются только `confirmed_users`.**

---

## 6. Контентная модель

### 6.1 Posts (новости / анонсы / розыгрыши-инфо)

- Пост — это сообщение, созданное администратором в боте.
- Типы:
  - текст;
  - фото + подпись;
  - видео + подпись;
  - анимация (GIF) + подпись.
- Форматирование — стандартное Telegram (Markdown/HTML).

Посты:
- не имеют отдельного публичного списка;
- отображаются пользователям как сообщения в диалоге с ботом;
- не редактируются после публикации.

### 6.2 Pages (справочные страницы)

Key-value страницы, редактируемые администратором:

- `locations_schedule` — локации и расписание;
- `faq` — часто задаваемые вопросы;
- `contacts` — контакты и помощь;
- `photo_link` — ссылка на фото/видео (например, Яндекс.Диск).

Каждая страница хранится как один текстовый блок.

---

## 7. User Stories

### US-1. Пользователь подтверждает регистрацию

**Как** пользователь,  
**я хочу** подтвердить регистрацию через Telegram-бот,  
**чтобы** участвовать в проекте «Неделя кёрлинга».

**Definition of Done:**
- пользователь пришёл по валидному токену;
- бот установил статус `TOKEN_VERIFIED`;
- пользователь уведомлён о необходимости подписки.

---

### US-2. Пользователь подтверждает подписку

**Как** пользователь,  
**я хочу** подтвердить подписку на обязательный канал,  
**чтобы** завершить регистрацию.

**Definition of Done:**
- бот проверяет подписку;
- при успехе статус становится `CONFIRMED`;
- пользователь получает сообщение о подтверждении регистрации.

---

### US-3. Пользователь без токена

**Как** пользователь,  
**я хочу** понять, почему не могу участвовать,  
**если** не проходил регистрацию на сайте.

**Definition of Done:**
- бот сообщает, что регистрация на сайте не завершена;
- бот даёт ссылку на сайт проекта.

---

### US-4. Администратор создаёт пост (новость)

**Как** администратор,  
**я хочу** создать пост и отправить его участникам проекта.

#### Flow:
1. Админ нажимает **«Добавить пост»**.
2. Бот просит отправить одним сообщением текст или медиа.
3. Сообщение сохраняется как **draft**.
4. Бот показывает кнопки:
   - «Предпросмотр»
   - «Изменить»
   - «Отмена»
5. При «Предпросмотр» бот показывает предпросмотр только админу.
6. Админ может:
   - изменить (draft перезаписывается);
   - опубликовать;
   - отменить.
7. При публикации пост рассылается всем `confirmed_users`.
8. После публикации редактирование невозможно.

**Definition of Done:**
- у администратора может быть только один активный draft;
- предпросмотр видит только администратор;
- рассылка идёт только `confirmed_users`;
- ошибки доставки логируются и не прерывают процесс.

---

### US-5. Администратор обновляет страницы

**Как** администратор,  
**я хочу** обновлять справочную информацию проекта.

**Definition of Done:**
- администратор выбирает страницу;
- отправляет текст одним сообщением;
- страница сохраняется и доступна пользователям.

---

## 8. Ограничения и безопасность

- Хранить только:
  - `tg_id`,
  - `username` (если доступен),
  - статус регистрации,
  - timestamps.
- Все секреты (JWT secret, bot token) — через `.env`.
- Пользователи, заблокировавшие бота, помечаются неактивными.
- Персонализированные напоминания по времени не реализуются.

---

## 9. Область вне текущего MVP

- Конкурсы и розыгрыши с механикой участия;
- Персональные напоминания по дате визита;
- Админская web-панель;
- Множественные проекты (один бот — один проект).
