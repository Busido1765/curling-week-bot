# DEV_GUIDE.md  
Проект: Telegram-бот «Неделя кёрлинга»

## 1. Назначение документа

Этот документ описывает:
- как ведётся разработка проекта;
- архитектурные принципы;
- правила работы с Codex;
- способы локального запуска и деплоя;
- требования к коду и структуре проекта.

Документ является **источником истины** для всех изменений в коде.
Перед реализацией любой функциональности разработчик (или Codex)
должен сверяться с этим файлом и `REQUIREMENTS.md`.

---

## 2. Технологический стек

### Язык и платформа
- Python 3.11+
- Telegram Bot API

### Библиотеки (рекомендуемые, могут уточняться)
- `aiogram` (или эквивалент async-фреймворка)
- `pydantic` — конфигурация и модели
- `sqlalchemy` (async) — ORM
- `alembic` — миграции БД
- `python-dotenv` — работа с env

### База данных
- PostgreSQL
- Одна PostgreSQL-инстанция
- Отдельная база данных для каждого бота

---

## 3. Архитектурные принципы

### 3.1 Общие принципы
- Один бот = один проект.
- Бизнес-логика отделена от Telegram handlers.
- Конфигурация только через переменные окружения.
- Отсутствие хардкода (ID каналов, ADMIN_IDS, секреты).

### 3.2 Stateless handlers
- Telegram handlers не хранят состояние в памяти.
- Вся логика состояний (draft, статус регистрации и т.д.) хранится в БД.

### 3.3 Явные состояния
- Используется явная модель статусов регистрации пользователя.
- Draft-посты админов — явное состояние, а не временная логика.

---

## 4. Структура проекта (рекомендуемая)

project_root/
├── bot/
│ ├── main.py # точка входа
│ ├── config.py # env + pydantic
│ ├── dispatcher.py # регистрация handlers
│ │
│ ├── handlers/
│ │ ├── user.py
│ │ ├── admin.py
│ │ └── common.py
│ │
│ ├── services/
│ │ ├── token_verifier.py
│ │ ├── subscription_checker.py
│ │ ├── broadcast.py
│ │ └── pages.py
│ │
│ ├── models/
│ │ ├── user.py
│ │ ├── post.py
│ │ └── page.py
│ │
│ ├── db/
│ │ ├── base.py
│ │ ├── session.py
│ │ └── migrations/
│ │
│ └── utils/
│ └── throttling.py
│
├── docs/
│ ├── REQUIREMENTS.md
│ └── DEV_GUIDE.md
│
├── Dockerfile
├── docker-compose.yml
├── .env.example
├── README.md
└── pyproject.toml / requirements.txt


Структура может расширяться, но основные слои должны сохраняться.

---

## 5. Работа с Codex

### 5.1 Общие правила
- Codex **обязан** учитывать `REQUIREMENTS.md` и `DEV_GUIDE.md`.
- Codex не должен:
  - добавлять функциональность вне требований;
  - усложнять архитектуру без запроса;
  - вводить новые сущности без согласования.

### 5.2 Режим работы
Рекомендуемый режим:
1. Формулируется конкретная задача (1 user story или её часть).
2. Codex:
   - предлагает реализацию;
   - описывает, какие файлы меняются;
   - пишет код.
3. Код проверяется и фиксируется в git.

### 5.3 Запрещённые паттерны
- “Сделаем на будущее”
- “А вдруг потом понадобится”
- Магические числа и строки
- Хардкод токенов / ID

---

## 6. Работа с базой данных

### 6.1 Общие правила
- Все изменения схемы БД — только через Alembic.
- Никаких auto-create таблиц на старте приложения.
- Явные миграции с осмысленными названиями.

### 6.2 Основные сущности
- User
- Post (draft / sent)
- Page (key-value)

---

## 7. Админский функционал

### 7.1 Draft-посты
- У каждого администратора может быть **только один активный draft**.
- Draft хранится в БД.
- Draft перезаписывается при редактировании.
- После публикации draft удаляется.

### 7.2 Предпросмотр
- Предпросмотр доступен только админу.
- Используется `copyMessage` или эквивалент.
- Предпросмотр не считается публикацией.

---

## 8. Рассылки

- Рассылки выполняются только для `confirmed_users`.
- Ошибки доставки:
  - логируются;
  - не останавливают процесс.
- Пользователь, заблокировавший бота, помечается неактивным.

---

## 9. Docker и деплой

### 9.1 Поддержка Docker
Проект должен поддерживать запуск:
- **без Docker** (локально);
- **через Docker Compose**.

Docker не является обязательным для разработки,
но является рекомендуемым способом деплоя.

### 9.2 Docker Compose
- Отдельный сервис для бота.
- Отдельный сервис для PostgreSQL.
- PostgreSQL использует volume для данных.
- Все параметры передаются через env.

### 9.3 Альтернатива
Допускается деплой через:
- `venv`
- `systemd`

при условии соблюдения всех требований к конфигурации.

---

## 10. Переменные окружения

Минимальный набор:
- `BOT_TOKEN`
- `DATABASE_URL`
- `JWT_SECRET`
- `ADMIN_IDS`
- `REQUIRED_CHANNELS`

Все переменные документируются в `.env.example`.

---

## 11. Логи и отладка

- Используется стандартный logging Python.
- Уровни логирования:
  - INFO — бизнес-события;
  - WARNING — нестандартные ситуации;
  - ERROR — ошибки выполнения.
- В продакшене запрещены `print()`.

---

## 12. Границы ответственности

Этот проект:
- не реализует конкурсы;
- не реализует персональные напоминания по времени;
- не содержит web-интерфейса администрирования.

Все эти функции возможны только в рамках отдельных проектов или расширений.

---

## 13. Принцип принятия решений

Если возникает неоднозначность:
1. Приоритет — `REQUIREMENTS.md`.
2. Затем — `DEV_GUIDE.md`.
3. Затем — простота и надёжность.
4. Затем — расширяемость, но без усложнения MVP.
